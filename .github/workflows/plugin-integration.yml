name: Plugin (swc)

env:
  RUST_LOG: "debug"
  SWC_CACHE_TEST: 1

on: [push, pull_request]

jobs:
  verify:
    name: Verify plugin - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-10.15
          - windows-latest

    steps:
      - uses: actions/checkout@v2

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal

      - uses: actions/setup-node@v2
        with:
          node-version: "16"

      - name: Install integration test plugin
        run: |
          (cd plugin && yarn)

      - name: Invoke test plugin
        run: |
          cargo test -p swc_plugin_runner

  verify-musl:
    name: Verify plugin - musl
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Pull docker images
        run: |
          docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD $DOCKER_REGISTRY_URL
          docker pull $DOCKER_REGISTRY_URL/napi-rs/napi-rs/nodejs-rust:lts-alpine
          docker tag $DOCKER_REGISTRY_URL/napi-rs/napi-rs/nodejs-rust:lts-alpine builder
        env:
          DOCKER_REGISTRY_URL: ghcr.io
          DOCKER_USERNAME: ${{ github.actor }}
          DOCKER_PASSWORD: ${{ secrets.GITHUB_TOKEN }}

      - name: Run test
        run: |
          docker run --rm -v ~/.cargo/git:/root/.cargo/git -v ~/.cargo/registry:/root/.cargo/registry -v $(pwd):/build -w /build builder sh -c '(cd plugin && yarn) cargo test -p swc_plugin_runner'
